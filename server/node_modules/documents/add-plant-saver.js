var db = require('db')
var reducer = require('shared').addPlantReducer
var createStore = require('redux').createStore

module.exports = function saveAddPlantDocument(userId, addPlantDocument, cb) {
	const store = createStore(reducer, addPlantDocument)

	loadAccountAndUser(db, userId).then(({ account, user }) => {
		store.dispatch({
			type: 'ADD_USER',
			payload: user.userId
		})
		store.dispatch({
			type: 'ADD_ACCOUNT',
			payload: account.accountId
		})
		store.dispatch({
			type: 'TAG_SCOPE',
			payload: account.defaultTagScope
		})

		db.plant.saveAddPlantDocument(store.getState(), cb)
	}, cb)
}

function loadAccountAndUser(db, userId) {
	return db.promise.user.load(userId).then(user => {
		return db.promise.account.load(user.accountId).then(account => {
			return {
				account,
				user
			}
		})
	})
}
